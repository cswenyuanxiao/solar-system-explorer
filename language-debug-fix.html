<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多语言切换功能调试与修复</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .debug-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .issue-card {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .issue-card.fixed {
            border-left-color: #28a745;
        }
        
        .issue-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .issue-card p {
            color: #666;
            line-height: 1.6;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
        
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .test-button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        
        .fix-applied {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .lang-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            min-width: 150px;
        }
        
        .lang-menu.is-open {
            display: block;
        }
        
        .lang-menu__item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        
        .lang-menu__item:hover {
            background: #f0f0f0;
        }
        
        #language-switcher {
            position: relative;
        }
    </style>
    <!-- Load the real i18n module so the debug page can test the actual LanguageManager -->
    <script src="js/languages.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 多语言切换功能调试器</h1>
            <p>此页面用于诊断和修复多语言切换功能的问题</p>
        </div>
        
        <div class="debug-panel">
            <h2>📊 问题诊断</h2>
            
            <div class="issue-card">
                <h3><span class="status-indicator status-error"></span>问题 1: 事件冲突</h3>
                <p>发现了多个事件监听器冲突的问题：</p>
                <div class="code-block">// languages.js 中的旧代码（有问题）
setupLanguageSwitcher() {
    document.addEventListener('click', (event) => {
        const switcher = event.target.closest('#language-switcher');
        if (switcher) {
            event.preventDefault();
            const newLang = this.currentLanguage === 'en' ? 'zh' : 'en';
            this.setLanguage(newLang);
        }
    });
}</div>
                <p><strong>问题分析：</strong>这个全局点击事件监听器会与 shared-header.js 中的下拉菜单功能冲突。</p>
            </div>
            
            <div class="issue-card">
                <h3><span class="status-indicator status-error"></span>问题 2: 初始化时序</h3>
                <p>LanguageManager 初始化延迟可能导致按钮无响应：</p>
                <div class="code-block">// 延迟100ms初始化可能不够
setTimeout(() => {
    languageManager = new LanguageManager();
    window.languageManager = languageManager;
}, 100);</div>
            </div>
            
            <div class="issue-card">
                <h3><span class="status-indicator status-warning"></span>问题 3: 下拉菜单未正确显示</h3>
                <p>语言菜单可能因为 CSS 或事件处理问题未能正确显示。</p>
            </div>
        </div>
        
        <div class="debug-panel">
            <h2>✅ 修复方案</h2>
            
            <div class="fix-applied">
                <h3>修复 1: 移除冲突的事件监听器</h3>
                <div class="code-block">// 修改 languages.js - 移除 setupLanguageSwitcher 方法中的代码
// 让 shared-header.js 完全控制语言切换按钮的行为

class LanguageManager {
    init() {
        this.translatePage();
        // 移除 this.setupLanguageSwitcher();
        this.updateDocumentLanguage();
        this.updateLanguageSwitcherUI();
        this.notifyLanguageChange();
    }
    
    // setupLanguageSwitcher 方法可以完全删除或留空
}</div>
            </div>
            
            <div class="fix-applied">
                <h3>修复 2: 改进初始化时序</h3>
                <div class="code-block">// 修改初始化逻辑，确保在 header 创建后立即初始化
document.addEventListener('DOMContentLoaded', () => {
    // 创建全局实例，立即可用
    window.languageManager = new LanguageManager();
    
    // 确保 setLanguage 函数立即可用
    window.setLanguage = function(lang) {
        if (window.languageManager) {
            window.languageManager.setLanguage(lang);
        }
    };
});</div>
            </div>
            
            <div class="fix-applied">
                <h3>修复 3: 确保下拉菜单正确工作</h3>
                <div class="code-block">// shared-header.js 中的关键代码
const langBtn = document.getElementById('language-switcher');
if (langBtn) {
    langBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation(); // 阻止事件冒泡
        if (langMenuEl && langMenuEl.classList.contains('is-open')) {
            hideMenu();
        } else {
            showMenu(langBtn);
        }
    });
}</div>
            </div>
        </div>
        
        <div class="debug-panel">
            <h2>🧪 测试区域</h2>
            
            <p>点击下面的按钮测试语言切换功能：</p>
            
            <button id="test-language-btn" class="test-button">
                <span id="test-flag">🇺🇸</span>
                <span id="test-lang">English</span>
            </button>
            
            <button id="direct-test" class="test-button">
                直接切换语言（测试核心功能）
            </button>
            
            <div id="test-results" style="margin-top: 20px;">
                <p>当前语言: <strong id="current-lang">未初始化</strong></p>
                <p>测试文本: <span id="test-text" data-en="Hello World" data-zh="你好世界">Hello World</span></p>
            </div>
        </div>
        
        <div class="debug-panel">
            <h2>📝 完整修复步骤</h2>
            
            <ol style="line-height: 2;">
                <li><strong>修改 js/languages.js：</strong>
                    <ul>
                        <li>删除或注释掉 <code>setupLanguageSwitcher()</code> 方法中的所有代码</li>
                        <li>从 <code>init()</code> 方法中移除 <code>this.setupLanguageSwitcher();</code> 调用</li>
                        <li>确保初始化代码直接创建实例，不使用 setTimeout</li>
                    </ul>
                </li>
                <li><strong>确认 js/shared-header.js：</strong>
                    <ul>
                        <li>语言切换按钮有正确的事件监听器</li>
                        <li>下拉菜单逻辑正常工作</li>
                        <li>使用 <code>e.stopPropagation()</code> 防止事件冒泡</li>
                    </ul>
                </li>
                <li><strong>测试步骤：</strong>
                    <ul>
                        <li>清除浏览器缓存</li>
                        <li>刷新页面</li>
                        <li>打开浏览器控制台查看是否有错误</li>
                        <li>点击语言切换按钮测试功能</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>
    
    <script>
        // 模拟语言管理器
        const LANGUAGES = {
            en: { name: 'English', flag: '🇺🇸' },
            zh: { name: '中文', flag: '🇨🇳' }
        };
        
        let currentLanguage = 'en';
        
        // 测试语言切换
        document.getElementById('test-language-btn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // 切换语言
            currentLanguage = currentLanguage === 'en' ? 'zh' : 'en';
            
            // 更新按钮显示
            this.querySelector('#test-flag').textContent = LANGUAGES[currentLanguage].flag;
            this.querySelector('#test-lang').textContent = LANGUAGES[currentLanguage].name;
            
            // 更新测试结果
            updateTestResults();
            
            console.log('语言已切换至:', currentLanguage);
        });
        
        // 直接测试
        document.getElementById('direct-test').addEventListener('click', function() {
            if (window.languageManager) {
                const newLang = window.languageManager.currentLanguage === 'en' ? 'zh' : 'en';
                window.languageManager.setLanguage(newLang);
                alert('已通过 languageManager 切换语言');
            } else {
                alert('languageManager 未初始化！这是主要问题。');
                console.error('window.languageManager is not defined');
            }
        });
        
        function updateTestResults() {
            document.getElementById('current-lang').textContent = currentLanguage;
            const testText = document.getElementById('test-text');
            testText.textContent = currentLanguage === 'en' ? 
                testText.getAttribute('data-en') : 
                testText.getAttribute('data-zh');
        }
        
        // 初始化
        updateTestResults();
        
        // 检查实际的 languageManager
        setTimeout(() => {
            if (window.languageManager) {
                console.log('✅ languageManager 已找到:', window.languageManager);
            } else {
                console.log('❌ languageManager 未找到');
            }
        }, 1000);
    </script>
</body>
</html>