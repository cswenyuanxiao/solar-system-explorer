<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA API Integration</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/loading-animations.css">
    <link rel="stylesheet" href="../css/optimized.css">
    <link rel="stylesheet" href="../css/api-features.css">
    <link rel="stylesheet" href="../css/download-manager.css">
</head>
<body>
    <!-- Page Loading Animation -->
    <div id="pageLoader" class="page-loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <div class="loader-text">Loading NASA API...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>
    
    <header>
        <div class="header-content">
            <h1>NASA API Integration</h1>
            <p class="subtitle">Real-time space data and daily astronomy pictures</p>
            
            <!-- Navigation -->
            <div class="header-actions">
                <a href="index.html" class="action-button">🏠 Home</a>
                <a href="charts.html" class="action-button">📊 Charts</a>
                <a href="education.html" class="action-button">📚 Education</a>
                <button id="themeToggle" class="action-button">🌙</button>
            </div>
        </div>
    </header>
    
    <main>
        <!-- API Key Management -->
        <div class="api-key-section">
            <h3>🔑 NASA API Key</h3>
            <div class="api-key-form">
                <input type="text" id="apiKeyInput" class="api-key-input" placeholder="Enter your NASA API key (optional)">
                <button id="saveApiKey" class="api-key-btn">Save Key</button>
                <button id="testApiKey" class="api-key-btn">Test Connection</button>
                <button id="clearApiKey" class="api-key-btn">Clear Key</button>
            </div>
            <div class="api-key-info">
                <p>💡 Get your free NASA API key at <a href="https://api.nasa.gov/" target="_blank">api.nasa.gov</a></p>
                <p>Using demo key for now - limited to 1000 requests per day</p>
                <p id="currentKeyStatus">Current key: Demo</p>
            </div>
        </div>
        
        <!-- Daily Astronomy Picture -->
        <div id="dailyAstronomy"></div>
        
        <!-- Space Weather Widget -->
        <div class="space-weather">
            <h3>🌤️ Space Weather</h3>
            <div id="spaceWeatherGrid" class="weather-grid">
                <div class="weather-item">
                    <div class="weather-icon">☀️</div>
                    <div class="weather-info">
                        <h4>Solar Activity</h4>
                        <p id="solarActivity">Loading...</p>
                    </div>
                </div>
                <div class="weather-item">
                    <div class="weather-icon">🌪️</div>
                    <div class="weather-info">
                        <h4>Solar Flares</h4>
                        <p id="solarFlares">Loading...</p>
                    </div>
                </div>
                <div class="weather-item">
                    <div class="weather-icon">🌍</div>
                    <div class="weather-info">
                        <h4>Geomagnetic Storms</h4>
                        <p id="geomagneticStorms">Loading...</p>
                    </div>
                </div>
                <div class="weather-item">
                    <div class="weather-icon">🔢</div>
                    <div class="weather-info">
                        <h4>Sunspot Count</h4>
                        <p id="sunspotCount">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daily Space Fact -->
        <div class="daily-fact">
            <h3>🌟 Daily Space Fact</h3>
            <p id="dailySpaceFact">Loading...</p>
        </div>
        
        <!-- API Statistics -->
        <div class="api-stats">
            <h3>📊 API Statistics</h3>
            <div id="apiStatsGrid" class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="cacheSize">0</span>
                    <span class="stat-label">Cached Items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="errorCount">0</span>
                    <span class="stat-label">Errors</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="apiKeyType">Demo</span>
                    <span class="stat-label">API Key Type</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="lastError">None</span>
                    <span class="stat-label">Last Error</span>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>&copy; 2024 Solar System Explorer. NASA API integration for educational purposes.</p>
    </footer>
    
    <script src="../js/app.js"></script>
    <script src="../js/lazy-loading.js"></script>
    <script src="../js/loading-manager.js"></script>
    <script src="../js/download-manager.js"></script>
    <script src="../js/nasa-api.js"></script>
    <script src="../js/daily-astronomy.js"></script>
    <script>
        // Simple and direct API key management with better error handling
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up API management...');
            
            // Force hide loader after a timeout to prevent infinite loading
            setTimeout(() => {
                const pageLoader = document.getElementById('pageLoader');
                if (pageLoader && !pageLoader.classList.contains('hidden')) {
                    console.log('Force hiding loader due to timeout');
                    pageLoader.classList.add('hidden');
                    pageLoader.style.display = 'none';
                }
            }, 3000); // Hide after 3 seconds if not already hidden
            
            // Initialize NASA API if not already done
            if (!window.nasaAPI) {
                console.log('Initializing NASA API...');
                try {
                    window.nasaAPI = new NASAAPI();
                    console.log('NASA API initialized successfully');
                } catch (error) {
                    console.error('Failed to initialize NASA API:', error);
                    // Still continue with the page setup
                }
            }
            
            // Setup direct event listeners
            setTimeout(() => {
                setupDirectEventListeners();
                loadSavedKey();
                updateStatus();
                loadSpaceWeather();
                loadDailySpaceFact();
            }, 500);
        });
        
        // Also hide loader when window loads
        window.addEventListener('load', () => {
            console.log('Window loaded, ensuring loader is hidden');
            const pageLoader = document.getElementById('pageLoader');
            if (pageLoader) {
                pageLoader.classList.add('hidden');
                setTimeout(() => {
                    pageLoader.style.display = 'none';
                }, 300);
            }
        });
        
        function setupDirectEventListeners() {
            console.log('Setting up direct event listeners...');
            
            const saveBtn = document.getElementById('saveApiKey');
            const testBtn = document.getElementById('testApiKey');
            const clearBtn = document.getElementById('clearApiKey');
            
            if (saveBtn) {
                console.log('Adding save button listener');
                saveBtn.addEventListener('click', handleSaveKey);
            }
            
            if (testBtn) {
                console.log('Adding test button listener');
                testBtn.addEventListener('click', handleTestConnection);
            }
            
            if (clearBtn) {
                console.log('Adding clear button listener');
                clearBtn.addEventListener('click', handleClearKey);
            }
        }
        
        function handleSaveKey() {
            console.log('Save button clicked!');
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                if (window.nasaAPI) {
                    window.nasaAPI.setAPIKey(key);
                    showNotification('✅ API key saved successfully!');
                    updateStatus();
                } else {
                    showNotification('❌ NASA API not initialized');
                }
            } else {
                showNotification('❌ Please enter a valid API key');
            }
        }
        
        function handleTestConnection() {
            console.log('Test button clicked!');
            if (window.nasaAPI) {
                showNotification('🔄 Testing API connection...');
                window.nasaAPI.testConnection().then(result => {
                    if (result.success) {
                        showNotification('✅ API connection successful!');
                    } else {
                        showNotification('❌ API connection failed: ' + result.message);
                    }
                }).catch(error => {
                    showNotification('❌ API test failed: ' + error.message);
                });
            } else {
                showNotification('❌ NASA API not initialized');
            }
        }
        
        function handleClearKey() {
            console.log('Clear button clicked!');
            if (window.nasaAPI) {
                window.nasaAPI.setAPIKey('DEMO_KEY');
                document.getElementById('apiKeyInput').value = '';
                showNotification('🗑️ API key cleared, using demo key');
                updateStatus();
            }
        }
        
        function loadSavedKey() {
            const savedKey = localStorage.getItem('nasa_api_key');
            if (savedKey && savedKey !== 'DEMO_KEY') {
                document.getElementById('apiKeyInput').value = savedKey;
            }
        }
        
        function updateStatus() {
            const statusElement = document.getElementById('currentKeyStatus');
            if (statusElement && window.nasaAPI) {
                const currentKey = window.nasaAPI.apiKey;
                const keyType = currentKey === 'DEMO_KEY' ? 'Demo' : 'Custom';
                statusElement.textContent = `Current key: ${keyType}`;
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #4CAF50;
                color: white;
                padding: 1rem 2rem;
                border-radius: 25px;
                z-index: 1000;
                font-weight: 600;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function loadSpaceWeather() {
            console.log('Loading space weather...');
            try {
                if (window.nasaAPI) {
                    const weather = window.nasaAPI.getSpaceWeather();
                    
                    document.getElementById('solarActivity').textContent = weather.condition;
                    document.getElementById('solarFlares').textContent = weather.solarFlare ? 'Active' : 'Quiet';
                    document.getElementById('geomagneticStorms').textContent = weather.geomagneticStorm ? 'Active' : 'Quiet';
                    document.getElementById('sunspotCount').textContent = weather.sunspotCount;
                } else {
                    // Fallback data
                    document.getElementById('solarActivity').textContent = 'Quiet';
                    document.getElementById('solarFlares').textContent = 'Quiet';
                    document.getElementById('geomagneticStorms').textContent = 'Quiet';
                    document.getElementById('sunspotCount').textContent = '15';
                }
            } catch (error) {
                console.error('Error loading space weather:', error);
                // Set fallback values
                document.getElementById('solarActivity').textContent = 'Unknown';
                document.getElementById('solarFlares').textContent = 'Unknown';
                document.getElementById('geomagneticStorms').textContent = 'Unknown';
                document.getElementById('sunspotCount').textContent = 'Unknown';
            }
        }
        
        function loadDailySpaceFact() {
            console.log('Loading daily space fact...');
            try {
                if (window.nasaAPI) {
                    window.nasaAPI.getDailySpaceFact().then(fact => {
                        document.getElementById('dailySpaceFact').textContent = fact;
                    }).catch(() => {
                        document.getElementById('dailySpaceFact').textContent = 
                            "The Sun contains 99.86% of the solar system's mass";
                    });
                } else {
                    document.getElementById('dailySpaceFact').textContent = 
                        "The Sun contains 99.86% of the solar system's mass";
                }
            } catch (error) {
                console.error('Error loading daily space fact:', error);
                document.getElementById('dailySpaceFact').textContent = 
                    "The Sun contains 99.86% of the solar system's mass";
            }
        }
    </script>
</body>
</html> 