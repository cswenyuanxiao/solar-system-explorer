<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA API Integration</title>
    <link rel="stylesheet" href="../css/style.css?v=20250109">
</head>
<body>
    <header class="header">
    </header>
    
    <main>
        <!-- API Key Management -->
        <div class="api-key-section">
            <h3>üîë NASA API Key</h3>
            <div class="api-key-form">
                <input type="text" id="apiKeyInput" class="api-key-input" placeholder="Enter your NASA API key (optional)">
                <button id="saveApiKey" class="api-key-btn">Save Key</button>
                <button id="testApiKey" class="api-key-btn">Test Connection</button>
                <button id="clearApiKey" class="api-key-btn">Clear Key</button>
            </div>
            <div class="api-key-info">
                <p>üí° Get your free NASA API key at <a href="https://api.nasa.gov/" target="_blank">api.nasa.gov</a></p>
                <p>Using demo key for now - limited to 1000 requests per day</p>
                <p id="currentKeyStatus">Current key: Demo</p>
            </div>
        </div>
        
        <!-- Daily Astronomy Picture -->
        <div id="dailyAstronomy"></div>

        <!-- NASA Search & NEO/Earth Imagery Controls -->
        <section class="api-key-section" style="margin-top: var(--space-xl);">
            <h3>üõ∞Ô∏è NASA Data Explorer</h3>
            <div class="api-key-form" style="grid-template-columns: 1fr auto auto;">
                <input type="text" id="nasaSearchInput" class="api-key-input" placeholder="Search NASA media (e.g., Mars, Hubble)">
                <button id="nasaSearchBtn" class="api-key-btn">Search</button>
                <button id="loadNEO" class="api-key-btn">Load NEO (today)</button>
            </div>
            <div id="nasaSearchResults" class="search-results" style="margin-top: var(--space-md);"></div>
        </section>
        
        <!-- Space Weather Widget -->
        <div class="space-weather">
            <h3>üå§Ô∏è Space Weather</h3>
            <div id="spaceWeatherGrid" class="weather-grid">
                <div class="weather-item">
                    <div class="weather-icon">‚òÄÔ∏è</div>
                    <div class="weather-info">
                        <h4>Solar Activity</h4>
                        <p id="solarActivity">Loading...</p>
                    </div>
                </div>
                <div class="weather-item">
                    <div class="weather-icon">üå™Ô∏è</div>
                    <div class="weather-info">
                        <h4>Solar Flares</h4>
                        <p id="solarFlares">Loading...</p>
                    </div>
                </div>
                <div class="weather-item">
                    <div class="weather-icon">üåç</div>
                    <div class="weather-info">
                        <h4>Geomagnetic Storms</h4>
                        <p id="geomagneticStorms">Loading...</p>
                    </div>
                </div>
                <div class="weather-item">
                    <div class="weather-icon">üî¢</div>
                    <div class="weather-info">
                        <h4>Sunspot Count</h4>
                        <p id="sunspotCount">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Daily Space Fact -->
        <div class="daily-fact">
            <h3>üåü Daily Space Fact</h3>
            <p id="dailySpaceFact">Loading...</p>
        </div>
        
        <!-- API Statistics -->
        <div class="api-stats">
            <h3>üìä API Statistics</h3>
            <div id="apiStatsGrid" class="stats-grid">
                <div class="stat-item">
                    <span class="stat-value" id="cacheSize">0</span>
                    <span class="stat-label">Cached Items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="errorCount">0</span>
                    <span class="stat-label">Errors</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="apiKeyType">Demo</span>
                    <span class="stat-label">API Key Type</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="lastError">None</span>
                    <span class="stat-label">Last Error</span>
                </div>
            </div>
        </div>
    </main>
    
    <footer>
        <p>&copy; 2024 Solar System Explorer. NASA API integration for educational purposes.</p>
    </footer>
    
    <script src="../js/languages.js?v=20250109"></script>
    <script src="../js/app.js"></script>
    <script src="../js/lazy-loading.js"></script>
    <script src="../js/download-manager.js"></script>
    <script src="../js/nasa-api.js"></script>
    <script src="../js/daily-astronomy.js"></script>
    <script>
        // Simplified API key management now that loading is more robust
        document.addEventListener('DOMContentLoaded', () => {
            // NASA API is auto-initialized in nasa-api.js
            // Just wait a bit to ensure it's ready
            setTimeout(() => {
                setupDirectEventListeners();
                loadSavedKey();
                updateStatus();
                loadSpaceWeather();
                loadDailySpaceFact();
            }, 200);
        });
        
        function setupDirectEventListeners() {
            document.getElementById('saveApiKey')?.addEventListener('click', handleSaveKey);
            document.getElementById('testApiKey')?.addEventListener('click', handleTestConnection);
            document.getElementById('clearApiKey')?.addEventListener('click', handleClearKey);
        }
        
        function handleSaveKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key && window.nasaAPI) {
                window.nasaAPI.setAPIKey(key);
                showNotification('‚úÖ API key saved successfully!');
                updateStatus();
            } else {
                showNotification('‚ùå Please enter a valid API key');
            }
        }
        
        function handleTestConnection() {
            if (window.nasaAPI) {
                showNotification('üîÑ Testing API connection...');
                window.nasaAPI.testConnection().then(result => {
                    showNotification(result.success ? '‚úÖ API connection successful!' : `‚ùå API connection failed: ${result.message}`);
                }).catch(error => {
                    showNotification(`‚ùå API test failed: ${error.message}`);
                });
            }
        }
        
        function handleClearKey() {
            if (window.nasaAPI) {
                window.nasaAPI.setAPIKey('DEMO_KEY');
                document.getElementById('apiKeyInput').value = '';
                showNotification('üóëÔ∏è API key cleared, using demo key');
                updateStatus();
            }
        }
        
        function loadSavedKey() {
            const savedKey = localStorage.getItem('nasa_api_key');
            if (savedKey && savedKey !== 'DEMO_KEY') {
                document.getElementById('apiKeyInput').value = savedKey;
            }
        }
        
        function updateStatus() {
            if (window.nasaAPI) {
                const keyType = window.nasaAPI.apiKey === 'DEMO_KEY' ? 'Demo' : 'Custom';
                document.getElementById('currentKeyStatus').textContent = `Current key: ${keyType}`;
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'toast-notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        function loadSpaceWeather() {
            if (window.nasaAPI) {
                try {
                    const weather = window.nasaAPI.getSpaceWeather();
                    document.getElementById('solarActivity').textContent = weather.condition;
                    document.getElementById('solarFlares').textContent = weather.solarFlare ? 'Active' : 'Quiet';
                    document.getElementById('geomagneticStorms').textContent = weather.geomagneticStorm ? 'Active' : 'Quiet';
                    document.getElementById('sunspotCount').textContent = weather.sunspotCount;
                } catch (error) {
                    console.error('Error loading space weather:', error);
                    document.getElementById('solarActivity').textContent = 'Low';
                    document.getElementById('solarFlares').textContent = 'Quiet';
                    document.getElementById('geomagneticStorms').textContent = 'Quiet';
                    document.getElementById('sunspotCount').textContent = '12';
                }
            } else {
                console.error('NASA API not available');
                document.getElementById('solarActivity').textContent = 'Low';
                document.getElementById('solarFlares').textContent = 'Quiet';
                document.getElementById('geomagneticStorms').textContent = 'Quiet';
                document.getElementById('sunspotCount').textContent = '12';
            }
        }
        
        function loadDailySpaceFact() {
            if (window.nasaAPI) {
                window.nasaAPI.getDailySpaceFact().then(fact => {
                    document.getElementById('dailySpaceFact').textContent = fact;
                }).catch((error) => {
                    console.error('Error loading daily space fact:', error);
                    document.getElementById('dailySpaceFact').textContent = "The Sun contains 99.86% of the solar system's mass.";
                });
            } else {
                console.error('NASA API not available');
                document.getElementById('dailySpaceFact').textContent = "The Sun contains 99.86% of the solar system's mass.";
            }
        }

        // Extra NASA endpoints UI
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nasaSearchBtn')?.addEventListener('click', handleNasaSearch);
            document.getElementById('loadNEO')?.addEventListener('click', handleNEO);
        });

        async function handleNasaSearch(){
            const q = document.getElementById('nasaSearchInput').value.trim();
            if (!q) return;
            const el = document.getElementById('nasaSearchResults');
            el.innerHTML = '<div class="loading"></div>';
            try {
                const items = await window.nasaAPI.searchNASA(q, 'image');
                if (!items || items.length === 0) { el.innerHTML = '<p class="no-activity">No results.</p>'; return; }
                el.innerHTML = items.slice(0, 12).map(it => `
                    <a class="search-result-card" href="${it.url}" target="_blank" rel="noopener">
                        <img class="result-image" src="${it.url}" alt="${it.title || 'NASA image'}">
                        <div class="result-info">
                            <div class="result-title">${it.title || 'Untitled'}</div>
                            <div class="result-desc" style="color:var(--text-secondary);font-size:.9rem;">${(it.description||'').slice(0,120)}...</div>
                        </div>
                    </a>
                `).join('');
            } catch (e) {
                el.innerHTML = '<p class="no-activity">Failed to load NASA search.</p>';
            }
        }

        async function handleNEO(){
            const el = document.getElementById('nasaSearchResults');
            el.innerHTML = '<div class="loading"></div>';
            try {
                const today = new Date().toISOString().slice(0,10);
                const items = await window.nasaAPI.getNEOs(today, today);
                if (!items || items.length === 0) { el.innerHTML = '<p class="no-activity">No NEOs.</p>'; return; }
                el.innerHTML = items.slice(0, 8).map(it => `
                    <div class="search-result-card">
                        <div class="result-info">
                            <div class="result-title">${it.name}</div>
                            <div class="result-desc" style="color:var(--text-secondary);font-size:.9rem;">Date: ${it.date} ‚Ä¢ Hazardous: ${it.hazardous ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                el.innerHTML = '<p class="no-activity">Failed to load NEO data.</p>';
            }
        }
    </script>
    <script src="../js/shared-header.js?v=20250109"></script>
    <script src="../js/theme-manager.js?v=20250109"></script>
    <script src="../js/social-sharing.js?v=20250109"></script>
    <script src="../js/favorites.js?v=20250109"></script>
    <script src="../js/breadcrumbs.js?v=20250109"></script>
</body>
</html>
