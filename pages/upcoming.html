<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Upcoming - Solar System Explorer</title>
  <link rel="stylesheet" href="../css/style.css?v=20250109" />
</head>
<body>
  <header class="header"></header>
  <main class="main">
    <nav class="breadcrumbs" aria-label="Breadcrumb">
      <a class="breadcrumbs__link" href="../index.html">Home</a>
      <span class="breadcrumbs__sep">/</span>
      <span class="breadcrumbs__current">Upcoming</span>
    </nav>
    <section class="education-section" style="display:block">
      <h2 class="section__title">Upcoming (DONKI Notifications)</h2>
      <div class="info-card" style="margin-bottom:1rem">
        <label for="range">Range:</label>
        <select id="range">
          <option value="7">±7 days</option>
          <option value="14">±14 days</option>
          <option value="30">±30 days</option>
        </select>
      </div>
      <div id="upcomingList" class="search-results"></div>
      <div id="upcomingPager" class="pager" style="display:flex; gap:.5rem; align-items:center; justify-content:center; margin-top:1rem"></div>
    </section>
  </main>
  <footer><p>&copy; 2024 Solar System Explorer.</p></footer>
  <script src="../js/languages.js?v=20250109"></script>
  <script src="../js/shared-header.js?v=20250109"></script>
  <script src="../js/theme-manager.js?v=20250109"></script>
  <script>
  const pageSize = 12;
  let items = [];
  let current = 1;
  function getApiKey(){ try { return localStorage.getItem('nasa_api_key') || 'DEMO_KEY'; } catch(_) { return 'DEMO_KEY'; } }
  async function fetchUpcoming(days=7){
    const now = new Date();
    const start = new Date(now.getTime() - Number(days)*24*3600*1000);
    const end = new Date(now.getTime() + Number(days)*24*3600*1000);
    const fmt = d=>d.toISOString().slice(0,10);
    const url = `https://api.nasa.gov/DONKI/notifications?startDate=${fmt(start)}&endDate=${fmt(end)}&type=all&api_key=${encodeURIComponent(getApiKey())}`;
    const resp = await fetch(url);
    const data = await resp.json();
    const arr = Array.isArray(data)?data:[];
    arr.sort((a,b)=> new Date(b.messageIssueTime||0) - new Date(a.messageIssueTime||0));
    return arr.map(n=>({
      title: (n.messageType? n.messageType+': ':'') + (n.messageSummary||'Notification'),
      date: n.messageIssueTime||'',
      link: n.messageURL || 'https://api.nasa.gov/'
    }));
  }
  function render(){
    const root = document.getElementById('upcomingList');
    const pager = document.getElementById('upcomingPager');
    const total = Math.ceil(items.length / pageSize) || 1;
    if(current>total) current=total;
    const start = (current-1)*pageSize;
    const slice = items.slice(start,start+pageSize);
    root.innerHTML = slice.map(it=>`
      <a class="search-result-card" href="${it.link}" target="_blank" rel="noopener">
        <div class="result-info">
          <div class="result-title">${it.title}</div>
          <div class="text-muted">${new Date(it.date).toLocaleString()}</div>
        </div>
      </a>
    `).join('');
    pager.innerHTML = `
      <button class="btn" ${current===1?'disabled':''} onclick="gotoPage(${current-1})">Prev</button>
      <span class="text-muted">Page ${current} / ${total}</span>
      <button class="btn" ${current===total?'disabled':''} onclick="gotoPage(${current+1})">Next</button>`;
  }
  function gotoPage(p){ if(p<1) return; current=p; render(); }
  // Basic runtime tests
  window.__runUpcomingTests = async function(){
    items = await fetchUpcoming(7);
    if (!Array.isArray(items)) throw new Error('Upcoming: not array');
    if (!items.length) return { ok:true, total:0, note:'No notifications in range' };
    const hasLink = items.some(it=>/^https?:\/\//.test(it.link));
    if (!hasLink) throw new Error('Upcoming: link missing');
    return { ok:true, total: items.length };
  }
  document.addEventListener('DOMContentLoaded', async ()=>{
    const sel = document.getElementById('range');
    sel.addEventListener('change', async ()=>{ current=1; items = await fetchUpcoming(sel.value); render(); });
    items = await fetchUpcoming(sel.value); render();
  });
  </script>
</body>
</html>


